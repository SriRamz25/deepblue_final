<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sentra Pay - Fraud Analytics Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
           DESIGN SYSTEM
           ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
        :root {
            --bg-primary: #0a0e1a;
            --bg-secondary: #111827;
            --bg-card: rgba(17, 24, 39, 0.7);
            --bg-card-hover: rgba(17, 24, 39, 0.9);
            --border: rgba(255, 255, 255, 0.06);
            --border-glow: rgba(99, 102, 241, 0.3);

            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;

            --accent-indigo: #818cf8;
            --accent-blue: #60a5fa;
            --accent-cyan: #22d3ee;
            --accent-emerald: #34d399;
            --accent-amber: #fbbf24;
            --accent-rose: #fb7185;
            --accent-purple: #a78bfa;

            --gradient-primary: linear-gradient(135deg, #818cf8, #60a5fa);
            --gradient-success: linear-gradient(135deg, #34d399, #22d3ee);
            --gradient-danger: linear-gradient(135deg, #fb7185, #f97316);
            --gradient-warning: linear-gradient(135deg, #fbbf24, #fb923c);

            --shadow-sm: 0 1px 3px rgba(0,0,0,0.3);
            --shadow-md: 0 4px 20px rgba(0,0,0,0.4);
            --shadow-lg: 0 10px 40px rgba(0,0,0,0.5);
            --shadow-glow: 0 0 30px rgba(99, 102, 241, 0.15);

            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-xl: 24px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Manrope', -apple-system, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* ‚ïê‚ïê‚ïê AMBIENT BACKGROUND ‚ïê‚ïê‚ïê */
        body::before {
            content: '';
            position: fixed; top: 0; left: 0;
            width: 100%; height: 100%;
            background:
                radial-gradient(ellipse 80% 60% at 10% 20%, rgba(99, 102, 241, 0.08), transparent),
                radial-gradient(ellipse 60% 50% at 90% 80%, rgba(34, 211, 238, 0.06), transparent),
                radial-gradient(ellipse 50% 40% at 50% 50%, rgba(168, 85, 247, 0.04), transparent);
            pointer-events: none; z-index: 0;
        }

        /* ‚ïê‚ïê‚ïê LAYOUT ‚ïê‚ïê‚ïê */
        .dashboard { position: relative; z-index: 1; padding: 24px 32px 48px; max-width: 1440px; margin: 0 auto; }

        /* ‚ïê‚ïê‚ïê HEADER ‚ïê‚ïê‚ïê */
        .header {
            display: flex; align-items: center; justify-content: space-between;
            margin-bottom: 32px; padding-bottom: 24px;
            border-bottom: 1px solid var(--border);
        }
        .header-left { display: flex; align-items: center; gap: 16px; }
        .logo {
            width: 44px; height: 44px; border-radius: var(--radius-md);
            background: var(--gradient-primary);
            display: flex; align-items: center; justify-content: center;
            font-size: 22px; box-shadow: var(--shadow-glow);
        }
        .header h1 { font-size: 22px; font-weight: 700; letter-spacing: -0.5px; }
        .header h1 span { background: var(--gradient-primary); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; }
        .header-subtitle { font-size: 13px; color: var(--text-muted); font-weight: 400; }
        .header-right { display: flex; align-items: center; gap: 16px; }
        .live-badge {
            display: flex; align-items: center; gap: 6px;
            padding: 6px 14px; border-radius: 20px;
            background: rgba(34, 211, 238, 0.1);
            border: 1px solid rgba(34, 211, 238, 0.2);
            font-size: 12px; font-weight: 500; color: var(--accent-cyan);
        }
        .live-dot {
            width: 7px; height: 7px; border-radius: 50%;
            background: var(--accent-cyan);
            animation: pulse-dot 2s infinite;
        }
        @keyframes pulse-dot {
            0%, 100% { opacity: 1; box-shadow: 0 0 0 0 rgba(34, 211, 238, 0.4); }
            50% { opacity: 0.7; box-shadow: 0 0 0 6px rgba(34, 211, 238, 0); }
        }
        .refresh-btn {
            padding: 8px 18px; border-radius: var(--radius-sm);
            background: rgba(255,255,255,0.05); border: 1px solid var(--border);
            color: var(--text-secondary); font-size: 13px; font-weight: 500;
            cursor: pointer; transition: all 0.2s;
        }
        .refresh-btn:hover { background: rgba(255,255,255,0.1); border-color: var(--border-glow); color: var(--text-primary); }

        /* ‚ïê‚ïê‚ïê KPI CARDS ‚ïê‚ïê‚ïê */
        .kpi-grid {
            display: grid; grid-template-columns: repeat(4, 1fr);
            gap: 20px; margin-bottom: 28px;
        }
        .kpi-card {
            background: var(--bg-card);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 24px;
            transition: all 0.3s ease;
            position: relative; overflow: hidden;
        }
        .kpi-card::before {
            content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px;
            border-radius: var(--radius-lg) var(--radius-lg) 0 0;
            opacity: 0; transition: opacity 0.3s;
        }
        .kpi-card:hover { transform: translateY(-2px); border-color: var(--border-glow); box-shadow: var(--shadow-glow); }
        .kpi-card:hover::before { opacity: 1; }
        .kpi-card:nth-child(1)::before { background: var(--gradient-primary); }
        .kpi-card:nth-child(2)::before { background: var(--gradient-success); }
        .kpi-card:nth-child(3)::before { background: var(--gradient-danger); }
        .kpi-card:nth-child(4)::before { background: var(--gradient-warning); }

        .kpi-icon {
            width: 42px; height: 42px; border-radius: var(--radius-md);
            display: flex; align-items: center; justify-content: center;
            font-size: 20px; margin-bottom: 14px;
        }
        .kpi-card:nth-child(1) .kpi-icon { background: rgba(129, 140, 248, 0.15); }
        .kpi-card:nth-child(2) .kpi-icon { background: rgba(52, 211, 153, 0.15); }
        .kpi-card:nth-child(3) .kpi-icon { background: rgba(251, 113, 133, 0.15); }
        .kpi-card:nth-child(4) .kpi-icon { background: rgba(251, 191, 36, 0.15); }

        .kpi-label { font-size: 12px; font-weight: 500; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.8px; margin-bottom: 6px; }
        .kpi-value { font-size: 28px; font-weight: 800; letter-spacing: -1px; line-height: 1.1; }
        .kpi-card:nth-child(1) .kpi-value { color: var(--accent-indigo); }
        .kpi-card:nth-child(2) .kpi-value { color: var(--accent-emerald); }
        .kpi-card:nth-child(3) .kpi-value { color: var(--accent-rose); }
        .kpi-card:nth-child(4) .kpi-value { color: var(--accent-amber); }
        .kpi-sub { font-size: 12px; color: var(--text-muted); margin-top: 8px; }

        /* ‚ïê‚ïê‚ïê CHART GRID ‚ïê‚ïê‚ïê */
        .chart-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px; margin-bottom: 28px;
        }
        .card {
            background: var(--bg-card);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 24px;
            transition: border-color 0.3s;
        }
        .card:hover { border-color: rgba(255,255,255,0.1); }
        .card-title {
            font-size: 14px; font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 20px;
            display: flex; align-items: center; gap: 8px;
        }
        .card-title .dot { width: 8px; height: 8px; border-radius: 50%; }

        /* ‚ïê‚ïê‚ïê BOTTOM GRID ‚ïê‚ïê‚ïê */
        .bottom-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px; margin-bottom: 28px;
        }

        /* ‚ïê‚ïê‚ïê TABLE ‚ïê‚ïê‚ïê */
        .table-card { grid-column: span 2; }
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; }
        th {
            font-size: 11px; font-weight: 600; text-transform: uppercase;
            letter-spacing: 0.8px; color: var(--text-muted);
            padding: 10px 14px; text-align: left;
            border-bottom: 1px solid var(--border);
        }
        td {
            font-size: 13px; padding: 12px 14px;
            border-bottom: 1px solid var(--border);
            color: var(--text-secondary);
        }
        tr:hover td { background: rgba(255,255,255,0.02); }
        .badge {
            display: inline-block; padding: 3px 10px;
            border-radius: 12px; font-size: 11px; font-weight: 600;
            text-transform: uppercase; letter-spacing: 0.5px;
        }
        .badge-low { background: rgba(52, 211, 153, 0.12); color: var(--accent-emerald); }
        .badge-moderate { background: rgba(251, 191, 36, 0.12); color: var(--accent-amber); }
        .badge-high { background: rgba(251, 113, 133, 0.12); color: var(--accent-rose); }
        .badge-very-high { background: rgba(239, 68, 68, 0.2); color: #ef4444; }
        .badge-completed { background: rgba(52, 211, 153, 0.12); color: var(--accent-emerald); }
        .badge-blocked { background: rgba(251, 113, 133, 0.12); color: var(--accent-rose); }
        .badge-pending { background: rgba(251, 191, 36, 0.12); color: var(--accent-amber); }

        .amount { font-weight: 600; color: var(--text-primary); }
        .txn-id { font-family: 'Manrope', sans-serif; font-size: 11px; color: var(--text-muted); }

        /* ‚ïê‚ïê‚ïê ACTION DISTRIBUTION ‚ïê‚ïê‚ïê */
        .action-bars { display: flex; flex-direction: column; gap: 14px; }
        .action-item { display: flex; align-items: center; gap: 12px; }
        .action-label { font-size: 12px; font-weight: 500; color: var(--text-secondary); min-width: 90px; }
        .action-bar-track {
            flex: 1; height: 8px; border-radius: 4px;
            background: rgba(255,255,255,0.05);
            overflow: hidden;
        }
        .action-bar-fill {
            height: 100%; border-radius: 4px;
            transition: width 1s ease;
        }
        .action-count { font-size: 13px; font-weight: 700; color: var(--text-primary); min-width: 30px; text-align: right; }

        /* ‚ïê‚ïê‚ïê USER TIERS ‚ïê‚ïê‚ïê */
        .tier-list { display: flex; flex-direction: column; gap: 12px; }
        .tier-item {
            display: flex; align-items: center; gap: 12px;
            padding: 14px 16px; border-radius: var(--radius-md);
            background: rgba(255,255,255,0.02);
            border: 1px solid var(--border);
            transition: all 0.2s;
        }
        .tier-item:hover { background: rgba(255,255,255,0.04); }
        .tier-icon { font-size: 28px; }
        .tier-info { flex: 1; }
        .tier-name { font-size: 13px; font-weight: 600; color: var(--text-primary); }
        .tier-desc { font-size: 11px; color: var(--text-muted); }
        .tier-count { font-size: 20px; font-weight: 800; }
        .tier-bronze .tier-count { color: #cd7f32; }
        .tier-silver .tier-count { color: #c0c0c0; }
        .tier-gold .tier-count { color: #ffd700; }

        /* ‚ïê‚ïê‚ïê LOADING STATE ‚ïê‚ïê‚ïê */
        .loading-overlay {
            position: fixed; inset: 0;
            background: var(--bg-primary);
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            z-index: 1000; transition: opacity 0.5s;
        }
        .loading-overlay.hide { opacity: 0; pointer-events: none; }
        .spinner {
            width: 48px; height: 48px;
            border: 3px solid var(--border);
            border-top-color: var(--accent-indigo);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading-text { margin-top: 16px; font-size: 14px; color: var(--text-muted); }

        /* ‚ïê‚ïê‚ïê EMPTY STATE ‚ïê‚ïê‚ïê */
        .empty-state {
            text-align: center; padding: 48px 24px; color: var(--text-muted);
        }
        .empty-state .emoji { font-size: 40px; margin-bottom: 12px; }
        .empty-state p { font-size: 14px; }

        /* ‚ïê‚ïê‚ïê RESPONSIVE ‚ïê‚ïê‚ïê */
        @media (max-width: 1200px) {
            .kpi-grid { grid-template-columns: repeat(2, 1fr); }
            .chart-grid { grid-template-columns: 1fr; }
            .bottom-grid { grid-template-columns: 1fr; }
            .table-card { grid-column: span 1; }
        }
        @media (max-width: 768px) {
            .dashboard { padding: 16px; }
            .kpi-grid { grid-template-columns: 1fr; }
            .header { flex-direction: column; align-items: flex-start; gap: 12px; }
        }
    </style>
</head>
<body>

<div class="loading-overlay" id="loadingOverlay">
    <div class="spinner"></div>
    <div class="loading-text">Loading Sentra Pay Analytics...</div>
</div>

<div class="dashboard">

    <!-- ‚ïê‚ïê‚ïê HEADER ‚ïê‚ïê‚ïê -->
    <header class="header">
        <div class="header-left">
            <div class="logo">üõ°Ô∏è</div>
            <div>
                <h1><span>Sentra Pay</span> Dashboard</h1>
                <div class="header-subtitle">Fraud Analytics & Risk Intelligence</div>
            </div>
        </div>
        <div class="header-right">
            <div class="live-badge"><div class="live-dot"></div> Live</div>
            <button class="refresh-btn" onclick="fetchData()">‚Üª Refresh</button>
        </div>
    </header>

    <!-- ‚ïê‚ïê‚ïê KPI CARDS ‚ïê‚ïê‚ïê -->
    <div class="kpi-grid">
        <div class="kpi-card">
            <div class="kpi-icon">üìä</div>
            <div class="kpi-label">Total Transactions</div>
            <div class="kpi-value" id="kpiTotalTxn">‚Äî</div>
            <div class="kpi-sub" id="kpiVolume">Volume: ‚Äî</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-icon">‚úÖ</div>
            <div class="kpi-label">Completed Payments</div>
            <div class="kpi-value" id="kpiCompleted">‚Äî</div>
            <div class="kpi-sub" id="kpiUsers">Total Users: ‚Äî</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-icon">üö®</div>
            <div class="kpi-label">Threats Blocked</div>
            <div class="kpi-value" id="kpiBlocked">‚Äî</div>
            <div class="kpi-sub" id="kpiFraudRate">Prevention Rate: ‚Äî</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-icon">‚ö°</div>
            <div class="kpi-label">Avg. Risk Score</div>
            <div class="kpi-value" id="kpiAvgRisk">‚Äî</div>
            <div class="kpi-sub">Lower is safer</div>
        </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê CHARTS ROW ‚ïê‚ïê‚ïê -->
    <div class="chart-grid">
        <div class="card">
            <div class="card-title"><div class="dot" style="background: var(--accent-blue)"></div> Transaction Volume (Last 7 Days)</div>
            <canvas id="volumeChart" height="90"></canvas>
        </div>
        <div class="card">
            <div class="card-title"><div class="dot" style="background: var(--accent-purple)"></div> Risk Distribution</div>
            <canvas id="riskDonut" height="220"></canvas>
        </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê BOTTOM ROW ‚ïê‚ïê‚ïê -->
    <div class="bottom-grid">
        <!-- Recent Transactions -->
        <div class="card table-card">
            <div class="card-title"><div class="dot" style="background: var(--accent-cyan)"></div> Recent Transactions</div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Txn ID</th>
                            <th>Receiver</th>
                            <th>Amount</th>
                            <th>Risk</th>
                            <th>Action</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="txnTableBody">
                        <tr><td colspan="6" class="empty-state"><div class="emoji">üì≠</div><p>No transactions yet</p></td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Right Column: Action Distribution + User Tiers -->
        <div style="display: flex; flex-direction: column; gap: 20px;">
            <div class="card">
                <div class="card-title"><div class="dot" style="background: var(--accent-emerald)"></div> Action Distribution</div>
                <div class="action-bars" id="actionBars"></div>
            </div>
            <div class="card">
                <div class="card-title"><div class="dot" style="background: var(--accent-amber)"></div> User Trust Tiers</div>
                <div class="tier-list" id="tierList"></div>
            </div>
        </div>
    </div>

</div>

<script>
    const API_BASE = window.location.origin;

    // ‚îÄ‚îÄ FORMATTERS ‚îÄ‚îÄ
    function formatCurrency(n) {
        if (n >= 10000000) return '‚Çπ' + (n / 10000000).toFixed(1) + ' Cr';
        if (n >= 100000) return '‚Çπ' + (n / 100000).toFixed(1) + ' L';
        if (n >= 1000) return '‚Çπ' + (n / 1000).toFixed(1) + 'K';
        return '‚Çπ' + n.toFixed(0);
    }

    function riskBadge(level) {
        const map = {
            'LOW': 'badge-low',
            'MODERATE': 'badge-moderate',
            'MEDIUM': 'badge-moderate',
            'HIGH': 'badge-high',
            'VERY_HIGH': 'badge-very-high'
        };
        return `<span class="badge ${map[level] || 'badge-moderate'}">${level || 'N/A'}</span>`;
    }

    function statusBadge(status) {
        const map = {
            'COMPLETED': 'badge-completed',
            'BLOCKED': 'badge-blocked',
            'PENDING': 'badge-pending',
            'FAILED': 'badge-high',
            'CANCELLED': 'badge-moderate'
        };
        return `<span class="badge ${map[status] || 'badge-pending'}">${status || 'N/A'}</span>`;
    }

    // ‚îÄ‚îÄ CHARTS ‚îÄ‚îÄ
    let volumeChart = null;
    let riskDonut = null;

    function createVolumeChart(data) {
        const ctx = document.getElementById('volumeChart').getContext('2d');
        if (volumeChart) volumeChart.destroy();

        const gradient = ctx.createLinearGradient(0, 0, 0, ctx.canvas.height);
        gradient.addColorStop(0, 'rgba(96, 165, 250, 0.25)');
        gradient.addColorStop(1, 'rgba(96, 165, 250, 0.0)');

        volumeChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: data.map(d => d.date),
                datasets: [{
                    label: 'Transactions',
                    data: data.map(d => d.count),
                    borderColor: '#60a5fa',
                    backgroundColor: gradient,
                    borderWidth: 2.5,
                    fill: true,
                    tension: 0.4,
                    pointRadius: 4,
                    pointBackgroundColor: '#60a5fa',
                    pointBorderColor: '#0a0e1a',
                    pointBorderWidth: 2,
                    pointHoverRadius: 7
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        backgroundColor: 'rgba(17,24,39,0.95)',
                        titleColor: '#f1f5f9', bodyColor: '#94a3b8',
                        borderColor: 'rgba(255,255,255,0.1)', borderWidth: 1,
                        cornerRadius: 8, padding: 12,
                        callbacks: {
                            afterBody: function(items) {
                                const idx = items[0].dataIndex;
                                return 'Volume: ' + formatCurrency(data[idx].volume);
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        grid: { color: 'rgba(255,255,255,0.04)' },
                        ticks: { color: '#64748b', font: { size: 11 } }
                    },
                    y: {
                        beginAtZero: true,
                        grid: { color: 'rgba(255,255,255,0.04)' },
                        ticks: { color: '#64748b', font: { size: 11 }, stepSize: 1 }
                    }
                }
            }
        });
    }

    function createRiskDonut(dist) {
        const ctx = document.getElementById('riskDonut').getContext('2d');
        if (riskDonut) riskDonut.destroy();

        const total = dist.low + dist.moderate + dist.high + dist.very_high;

        riskDonut = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Low', 'Moderate', 'High', 'Very High'],
                datasets: [{
                    data: [dist.low, dist.moderate, dist.high, dist.very_high],
                    backgroundColor: ['#34d399', '#fbbf24', '#fb7185', '#ef4444'],
                    borderColor: 'transparent',
                    borderWidth: 0,
                    hoverOffset: 8,
                    spacing: 3,
                    borderRadius: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                cutout: '68%',
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            color: '#94a3b8', padding: 16,
                            usePointStyle: true, pointStyleWidth: 10,
                            font: { size: 12 }
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(17,24,39,0.95)',
                        titleColor: '#f1f5f9', bodyColor: '#94a3b8',
                        borderColor: 'rgba(255,255,255,0.1)', borderWidth: 1,
                        cornerRadius: 8, padding: 12,
                        callbacks: {
                            label: function(ctx) {
                                const pct = total > 0 ? ((ctx.raw / total) * 100).toFixed(1) : 0;
                                return ` ${ctx.label}: ${ctx.raw} (${pct}%)`;
                            }
                        }
                    }
                }
            },
            plugins: [{
                id: 'centerText',
                afterDraw(chart) {
                    const { ctx, chartArea: { width, height, top } } = chart;
                    ctx.save();
                    ctx.textAlign = 'center';
                    ctx.fillStyle = '#f1f5f9';
                    ctx.font = '800 28px Manrope';
                    ctx.fillText(total, width / 2, top + height / 2 - 4);
                    ctx.fillStyle = '#64748b';
                    ctx.font = '500 11px Manrope';
                    ctx.fillText('TOTAL', width / 2, top + height / 2 + 16);
                    ctx.restore();
                }
            }]
        });
    }

    // ‚îÄ‚îÄ RENDER ‚îÄ‚îÄ
    function renderKPIs(kpis) {
        document.getElementById('kpiTotalTxn').textContent = kpis.total_transactions.toLocaleString();
        document.getElementById('kpiVolume').textContent = 'Volume: ' + formatCurrency(kpis.total_volume);
        document.getElementById('kpiCompleted').textContent = kpis.completed_count.toLocaleString();
        document.getElementById('kpiUsers').textContent = 'Total Users: ' + kpis.total_users;
        document.getElementById('kpiBlocked').textContent = kpis.blocked_count.toLocaleString();
        document.getElementById('kpiFraudRate').textContent = 'Prevention Rate: ' + kpis.fraud_prevention_rate + '%';
        document.getElementById('kpiAvgRisk').textContent = (kpis.avg_risk_score * 100).toFixed(0) + '%';
    }

    function renderTable(txns) {
        const tbody = document.getElementById('txnTableBody');
        if (!txns || txns.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="empty-state"><div class="emoji">üì≠</div><p>No transactions yet</p></td></tr>';
            return;
        }
        tbody.innerHTML = txns.map(t => `
            <tr>
                <td class="txn-id">${t.id}</td>
                <td>${t.receiver}</td>
                <td class="amount">${formatCurrency(t.amount)}</td>
                <td>${riskBadge(t.risk_level)}</td>
                <td>${t.action}</td>
                <td>${statusBadge(t.status)}</td>
            </tr>
        `).join('');
    }

    function renderActionBars(actions) {
        const container = document.getElementById('actionBars');
        const items = [
            { label: 'Allowed', count: actions.allowed, color: '#34d399' },
            { label: 'Warning', count: actions.warned, color: '#fbbf24' },
            { label: 'OTP Required', count: actions.otp_required, color: '#60a5fa' },
            { label: 'Blocked', count: actions.blocked, color: '#fb7185' }
        ];
        const max = Math.max(...items.map(i => i.count), 1);
        container.innerHTML = items.map(i => `
            <div class="action-item">
                <div class="action-label">${i.label}</div>
                <div class="action-bar-track">
                    <div class="action-bar-fill" style="width: ${(i.count / max) * 100}%; background: ${i.color};"></div>
                </div>
                <div class="action-count">${i.count}</div>
            </div>
        `).join('');
    }

    function renderTiers(tiers) {
        const container = document.getElementById('tierList');
        const items = [
            { name: 'Gold', icon: 'ü•á', desc: 'Trusted users', count: tiers.gold, cls: 'tier-gold' },
            { name: 'Silver', icon: 'ü•à', desc: 'Regular users', count: tiers.silver, cls: 'tier-silver' },
            { name: 'Bronze', icon: 'ü•â', desc: 'New users', count: tiers.bronze, cls: 'tier-bronze' }
        ];
        container.innerHTML = items.map(i => `
            <div class="tier-item ${i.cls}">
                <div class="tier-icon">${i.icon}</div>
                <div class="tier-info">
                    <div class="tier-name">${i.name}</div>
                    <div class="tier-desc">${i.desc}</div>
                </div>
                <div class="tier-count">${i.count}</div>
            </div>
        `).join('');
    }

    // ‚îÄ‚îÄ FETCH DATA ‚îÄ‚îÄ
    async function fetchData() {
        const overlay = document.getElementById('loadingOverlay');
        overlay.classList.remove('hide');

        try {
            const res = await fetch(`${API_BASE}/api/dashboard/stats`);
            if (!res.ok) throw new Error('API error');
            const data = await res.json();

            renderKPIs(data.kpis);
            createVolumeChart(data.daily_volume);
            createRiskDonut(data.risk_distribution);
            renderTable(data.recent_transactions);
            renderActionBars(data.action_distribution);
            renderTiers(data.user_tiers);

        } catch (err) {
            console.error('Dashboard fetch error:', err);
            // Show demo data if API is unreachable
            renderDemoData();
        } finally {
            setTimeout(() => overlay.classList.add('hide'), 400);
        }
    }

    function renderDemoData() {
        const demo = {
            kpis: { total_transactions: 0, total_volume: 0, completed_count: 0, total_users: 0, blocked_count: 0, fraud_prevention_rate: 0, avg_risk_score: 0 },
            daily_volume: Array.from({length: 7}, (_, i) => {
                const d = new Date(); d.setDate(d.getDate() - (6 - i));
                return { date: d.toLocaleDateString('en', {month: 'short', day: 'numeric'}), count: 0, volume: 0 };
            }),
            risk_distribution: { low: 0, moderate: 0, high: 0, very_high: 0 },
            action_distribution: { allowed: 0, warned: 0, otp_required: 0, blocked: 0 },
            recent_transactions: [],
            user_tiers: { bronze: 0, silver: 0, gold: 0 }
        };
        renderKPIs(demo.kpis);
        createVolumeChart(demo.daily_volume);
        createRiskDonut(demo.risk_distribution);
        renderTable(demo.recent_transactions);
        renderActionBars(demo.action_distribution);
        renderTiers(demo.user_tiers);
    }

    // ‚îÄ‚îÄ INIT ‚îÄ‚îÄ
    fetchData();
    // Auto-refresh every 30 seconds
    setInterval(fetchData, 30000);
</script>

</body>
</html>
